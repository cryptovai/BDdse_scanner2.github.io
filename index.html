<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Real-Time Stock Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        th:hover {
            background-color: #f1f5f9;
        }
        .sort-asc::after {
            content: " ↑";
        }
        .sort-desc::after {
            content: " ↓";
        }
        .bangla-text {
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .sector-btn {
            transition: all 0.2s;
        }
        .sector-btn:hover {
            transform: translateY(-1px);
        }
        .sector-btn.active {
            background-color: #1d4ed8;
            color: white;
        }
        .blink {
            animation: blink-animation 1.5s steps(2, start) infinite;
        }
        @keyframes blink-animation {
            to { visibility: hidden; }
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="fetchStockData()" class="flex items-center bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                </button>
                <h1 class="text-xl font-bold">DSE Real-Time Stock Screener</h1>
                <span id="connectionStatus" class="bg-green-500 text-white text-xs px-2 py-1 rounded-full blink">LIVE</span>
            </div>
            <div>
                <p class="text-blue-200 text-sm">বাংলাদেশ স্টক মার্কেট বিশ্লেষণ By Adnan Sayem</p>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Loading Placeholder -->
        <div id="loadingPlaceholder" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-500">রিয়েল-টাইম ডেটা লোড হচ্ছে...</p>
            <p id="retryCounter" class="text-xs text-gray-400 mt-1"></p>
        </div>

        <!-- Sector Filter -->
        <div id="sectorFilter" class="hidden mb-4">
            <div class="flex flex-wrap gap-2">
                <button onclick="filterBySector('all')" class="sector-btn active bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                    সব সেক্টর
                </button>
                <!-- Filled by JavaScript -->
            </div>
        </div>

        <!-- Main Table View -->
        <div id="tableView" class="mb-8 hidden">
            <div class="card overflow-hidden mb-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('ticker')">Ticker</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('sector')">Sector</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('ltp')">Price (BDT)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('change')">Change%</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('volume')">Volume</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('pe')">P/E</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100" onclick="sortTable('score')">Score</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Analysis</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-right text-xs text-gray-500">
                <span id="lastUpdated"></span>
                <span id="dataSource" class="ml-2"></span>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" class="hidden">
            <!-- Filled by JavaScript -->
        </div>

        <!-- Detailed Stock View -->
        <div id="detailView" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showTableView()" class="flex items-center text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                    </svg>
                    Back to All Stocks
                </button>
                <h2 id="detailStockName" class="text-xl font-bold text-gray-800"></h2>
                <div class="w-5"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Key Metrics Card -->
                <div class="card p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Key Metrics</h3>
                    <div class="space-y-2" id="keyMetrics">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <!-- Trading Metrics Card -->
                <div class="card p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Trading Metrics</h3>
                    <div class="space-y-2" id="tradingMetrics">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <!-- Valuation Card -->
                <div class="card p-4">
                    <h3 class="font-medium text-gray-700 mb-3">Valuation</h3>
                    <div class="space-y-2" id="valuationMetrics">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- TradingView Chart -->
            <div class="card p-4 mb-6">
                <h3 class="font-medium text-gray-700 mb-3">Technical Analysis</h3>
                <div id="chartDescription" class="text-gray-700 mb-3">
                    <!-- Filled by JavaScript -->
                </div>
                <a id="tradingviewLink" href="#" target="_blank" class="inline-block bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    View TradingView Chart →
                </a>
            </div>

            <!-- Analysis Summary -->
            <div class="card p-4 mb-6">
                <h3 class="font-medium text-gray-700 mb-3">Analysis & Recommendation</h3>
                <div id="analysisSummary" class="text-gray-700">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-blue-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>Stock Analysis By Adnan Sayem &copy; <span id="currentYear"></span> | Last Update: <span id="updateTime"></span></p>
        </div>
    </footer>

    <script>
        // Global variables
        let allStocks = [];
        let filteredStocks = [];
        let currentSort = { key: 'score', order: 'desc' };
        let currentStock = null;
        let currentSector = 'all';
        const refreshInterval = 120000; // 2 minutes
        let retryCount = 0;
        const MAX_RETRIES = 3;
        let currentEndpointIndex = 0;
        let autoRefreshInterval;
        let isFirstLoad = true;

        // DSE API Endpoints with multiple fallbacks
        const DSE_API_ENDPOINTS = [
            { 
                url: "https://www.dse.com.bd/datafeed/current_price.php",
                name: "DSE Official"
            },
            { 
                url: "https://dse.com.bd/datafeed/current_price.php", 
                name: "DSE Alternate" 
            },
            { 
                url: "https://www.dsebd.org/datafeed/current_price.php",
                name: "DSE Mirror"
            }
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            initApp();
        });

        function initApp() {
            showLoading();
            setupAutoRefresh();
            fetchStockData();
        }

        function setupAutoRefresh() {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = setInterval(fetchStockData, refreshInterval);
        }

        // Main data fetching function
        async function fetchStockData() {
            try {
                showLoading();
                
                const endpoint = DSE_API_ENDPOINTS[currentEndpointIndex];
                document.getElementById('dataSource').textContent = `Source: ${endpoint.name}`;
                
                const [priceData, companyData] = await Promise.all([
                    fetchWithTimeout(endpoint.url, 8000).then(handleResponse),
                    fetchWithTimeout(endpoint.url.replace('current_price', 'all_companies'), 8000)
                        .then(handleResponse)
                        .catch(() => ({})) // Empty fallback if company data fails
                ]);

                // Validate data
                if (!Array.isArray(priceData)) {
                    throw new Error("Invalid price data format");
                }

                // Process data
                allStocks = processRealTimeData(priceData, companyData);
                retryCount = 0; // Reset retry counter on success
                
                // Update UI
                updateUI();
                updateConnectionStatus(true);
                
                if (isFirstLoad) {
                    isFirstLoad = false;
                    document.getElementById('sectorFilter').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Error fetching real-time data:', error);
                handleDataError(error);
            }
        }

        function handleResponse(response) {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }

        // Enhanced fetch with timeout and cache busting
        async function fetchWithTimeout(resource, timeout = 8000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            try {
                const response = await fetch(resource, { 
                    signal: controller.signal,
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    cache: 'no-store'
                });
                clearTimeout(id);
                return response;
            } catch (error) {
                clearTimeout(id);
                throw error;
            }
        }

        // Process and validate real-time data
        function processRealTimeData(priceData, companyData = {}) {
            return priceData.map(stock => {
                // Validate required fields
                if (!stock.trading_code || !stock.ltp) {
                    console.warn("Invalid stock data:", stock);
                    return null;
                }
                
                const companyInfo = Array.isArray(companyData) 
                    ? companyData.find(c => c.trading_code === stock.trading_code) || {}
                    : companyData[stock.trading_code] || {};
                
                const changePercent = parseFloat(stock.change_percent) || 
                    (stock.ycp ? ((parseFloat(stock.ltp) - parseFloat(stock.ycp)) / parseFloat(stock.ycp) * 100 : 0);
                
                return {
                    ticker: stock.trading_code,
                    name: companyInfo.company_name || stock.trading_code,
                    sector: companyInfo.sector || 'Miscellaneous',
                    ltp: parseFloat(stock.ltp) || 0,
                    high: parseFloat(stock.high) || 0,
                    low: parseFloat(stock.low) || 0,
                    close: parseFloat(stock.closep) || 0,
                    ycp: parseFloat(stock.ycp) || 0,
                    change: parseFloat(stock.change) || 0,
                    changePercent: changePercent,
                    trade: parseInt(stock.trade) || 0,
                    volume: parseInt(stock.volume) || 0,
                    value: parseFloat(stock.value) || 0,
                    pe: parseFloat(stock.pe) || calculatePeRatio(stock),
                    score: calculateDynamicScore(stock),
                    lastUpdated: new Date().toISOString()
                };
            }).filter(stock => stock !== null); // Filter out invalid entries
        }

        // Calculate dynamic score based on multiple factors
        function calculateDynamicScore(stock) {
            let score = 50; // Base score
            
            // Positive factors
            if (stock.change > 0) score += 15;
            if (stock.volume > 100000) score += 10;
            if (stock.changePercent > 2) score += 5;
            if (stock.pe < 15) score += 10;
            
            // Negative factors
            if (stock.change < -5) score -= 10;
            if (stock.pe > 25) score -= 5;
            
            return Math.max(0, Math.min(100, score));
        }

        // Calculate PE ratio if missing
        function calculatePeRatio(stock) {
            return stock.ycp ? (stock.ltp / stock.ycp).toFixed(2) : 0;
        }

        // Handle data fetching errors
        function handleDataError(error) {
            retryCount++;
            
            if (retryCount <= MAX_RETRIES) {
                // Try next endpoint
                currentEndpointIndex = (currentEndpointIndex + 1) % DSE_API_ENDPOINTS.length;
                
                const retryIn = Math.min(3000 * retryCount, 15000); // Exponential backoff max 15s
                showError(`Data loading failed (Attempt ${retryCount}/${MAX_RETRIES}). Retrying in ${retryIn/1000} seconds...`);
                
                setTimeout(() => {
                    fetchStockData();
                }, retryIn);
            } else {
                showError("Could not connect to DSE servers. Please check your internet connection and try again later.");
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.classList.remove('bg-red-500', 'bg-gray-500', 'pulse');
                statusElement.classList.add('bg-green-500', 'blink');
                statusElement.textContent = "LIVE";
            } else {
                statusElement.classList.remove('bg-green-500', 'blink');
                statusElement.classList.add('bg-red-500', 'pulse');
                statusElement.textContent = "OFFLINE";
            }
        }

        function updateUI() {
            initSectorFilter();
            filterBySector(currentSector);
            updateLastUpdatedTime();
            
            document.getElementById('loadingPlaceholder').classList.add('hidden');
            document.getElementById('errorDisplay').classList.add('hidden');
            document.getElementById('tableView').classList.remove('hidden');
        }

        function showLoading() {
            const loadingDiv = document.getElementById('loadingPlaceholder');
            loadingDiv.classList.remove('hidden');
            loadingDiv.innerHTML = `
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                <p class="mt-2 text-gray-500">Loading real-time data...</p>
                <p id="retryCounter" class="text-xs text-gray-400 mt-1">Attempt ${retryCount + 1}/${MAX_RETRIES}</p>
            `;
            
            document.getElementById('tableView').classList.add('hidden');
            document.getElementById('errorDisplay').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.classList.remove('hidden');
            errorDiv.innerHTML = `
                <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4">
                    <div class="flex items-center">
                        <svg class="h-5 w-5 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        <strong>Error:</strong>
                    </div>
                    <p class="mt-1">${message}</p>
                    <button onclick="forceRetry()" class="mt-2 bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        Retry Now
                    </button>
                </div>
            `;
            
            document.getElementById('loadingPlaceholder').classList.add('hidden');
        }

        function forceRetry() {
            retryCount = 0;
            currentEndpointIndex = 0;
            fetchStockData();
        }

        // Initialize sector filter buttons
        function initSectorFilter() {
            const sectorContainer = document.getElementById('sectorFilter').querySelector('div');
            sectorContainer.innerHTML = '';
            
            // Get all unique sectors
            const sectors = [...new Set(allStocks.map(stock => stock.sector))];
            
            // Add sector buttons
            sectors.forEach(sector => {
                const btn = document.createElement('button');
                btn.className = 'sector-btn bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                btn.textContent = sector;
                btn.onclick = () => filterBySector(sector);
                sectorContainer.appendChild(btn);
            });
        }

        // Filter stocks by sector
        function filterBySector(sector) {
            currentSector = sector;
            
            // Update active button
            document.querySelectorAll('.sector-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-blue-100', 'text-blue-800');
            });
            
            if (sector === 'all') {
                filteredStocks = [...allStocks];
                document.querySelector('.sector-btn').classList.add('active', 'bg-blue-600', 'text-white');
            } else {
                filteredStocks = allStocks.filter(stock => stock.sector === sector);
                document.querySelectorAll('.sector-btn').forEach(btn => {
                    if (btn.textContent === sector) {
                        btn.classList.add('active', 'bg-blue-600', 'text-white');
                        btn.classList.remove('bg-blue-100', 'text-blue-800');
                    }
                });
            }
            
            renderStockTable();
        }

        // Render the stock table
        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            if (!tbody) return;

            // Sort stocks
            const sortedStocks = [...filteredStocks].sort((a, b) => {
                const aVal = a[currentSort.key];
                const bVal = b[currentSort.key];
                
                if (aVal === undefined || bVal === undefined) return 0;
                if (currentSort.order === 'asc') return aVal - bVal;
                return bVal - aVal;
            });

            // Efficient DOM updates
            let html = '';
            
            sortedStocks.forEach(stock => {
                const changeClass = stock.change >= 0 ? 'text-green-600' : 'text-red-600';
                const peColor = stock.pe < 15 ? 'text-green-600' : stock.pe < 25 ? 'text-yellow-600' : 'text-red-600';
                const scoreColor = stock.score > 75 ? 'text-green-600' : stock.score > 50 ? 'text-yellow-600' : 'text-red-600';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap font-medium">${stock.ticker}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.sector}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.ltp.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap ${changeClass}">
                            ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.volume.toLocaleString()}</td>
                        <td class="px-4 py-3 whitespace-nowrap ${peColor}">${stock.pe}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-bold ${scoreColor}">${stock.score}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button onclick="showStockDetail('${stock.ticker}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                Analyze
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Update sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('onclick')?.includes(`sortTable('${currentSort.key}')`)) {
                    th.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
            
            // Update last updated time
            document.getElementById('lastUpdated').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            document.getElementById('updateTime').textContent = new Date().toLocaleTimeString();
        }

        // Sort table by column
        function sortTable(key) {
            if (currentSort.key === key) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.order = 'desc';
            }
            renderStockTable();
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleTimeString();
        }

        // Show detailed view for a stock
        function showStockDetail(ticker) {
            currentStock = allStocks.find(s => s.ticker === ticker);
            if (!currentStock) return;

            document.getElementById('tableView').classList.add('hidden');
            document.getElementById('detailView').classList.remove('hidden');
            document.getElementById('detailStockName').textContent = `${currentStock.ticker} - ${currentStock.name}`;

            // Update key metrics
            document.getElementById('keyMetrics').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Sector:</span>
                    <span class="font-medium">${currentStock.sector}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Last Trade Price:</span>
                    <span class="font-medium">${currentStock.ltp.toFixed(2)} TK</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Yesterday's Close:</span>
                    <span class="font-medium">${currentStock.ycp.toFixed(2)} TK</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Change:</span>
                    <span class="font-medium ${currentStock.change >= 0 ? 'text-green-600' : 'text-red-600'}">
                        ${currentStock.change >= 0 ? '+' : ''}${currentStock.change.toFixed(2)} (${currentStock.changePercent.toFixed(2)}%)
                    </span>
                </div>
            `;

            // Update trading metrics
            document.getElementById('tradingMetrics').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">Today's High:</span>
                    <span class="font-medium">${currentStock.high.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Today's Low:</span>
                    <span class="font-medium">${currentStock.low.toFixed(2)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Volume:</span>
                    <span class="font-medium">${currentStock.volume.toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Trades:</span>
                    <span class="font-medium">${currentStock.trade.toLocaleString()}</span>
                </div>
            `;

            // Update valuation metrics
            document.getElementById('valuationMetrics').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">P/E Ratio:</span>
                    <span class="font-medium ${currentStock.pe < 15 ? 'text-green-600' : currentStock.pe < 25 ? 'text-yellow-600' : 'text-red-600'}">
                        ${currentStock.pe}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Score:</span>
                    <span class="font-medium ${currentStock.score > 75 ? 'text-green-600' : currentStock.score > 50 ? 'text-yellow-600' : 'text-red-600'}">
                        ${currentStock.score}/100
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">Last Updated:</span>
                    <span class="font-medium">${new Date(currentStock.lastUpdated).toLocaleTimeString()}</span>
                </div>
            `;

            // Update TradingView link
            document.getElementById('tradingviewLink').href = `https://www.tradingview.com/chart/?symbol=DHAKA%3A${currentStock.ticker}`;
            
            // Update chart description
            updateChartDescription();
            
            // Update analysis summary
            updateAnalysisSummary();
        }

        function updateChartDescription() {
            let description = `
                <p class="mb-2">Technical indicators for ${currentStock.ticker}:</p>
                <ul class="list-disc list-inside mb-3">
                    <li>Current Price: ${currentStock.ltp.toFixed(2)} (${currentStock.change >= 0 ? '+' : ''}${currentStock.changePercent.toFixed(2)}%)</li>
                    <li>Today's Range: ${currentStock.low.toFixed(2)} - ${currentStock.high.toFixed(2)}</li>
                    <li>Volume: ${currentStock.volume.toLocaleString()} shares</li>
                </ul>
                <p class="mb-2">Click below for advanced chart analysis:</p>
            `;
            
            document.getElementById('chartDescription').innerHTML = description;
        }

        function updateAnalysisSummary() {
            let summary = '';
            
            // Valuation analysis
            if (currentStock.pe < 10) {
                summary += `<p class="mb-2">This stock appears <span class="font-medium text-green-600">undervalued</span> with a P/E ratio of ${currentStock.pe} (below 10).</p>`;
            } else if (currentStock.pe > 25) {
                summary += `<p class="mb-2 text-red-600">Caution: This stock appears <span class="font-medium">overvalued</span> with a P/E ratio of ${currentStock.pe} (above 25).</p>`;
            } else {
                summary += `<p class="mb-2">This stock has a <span class="font-medium">reasonable valuation</span> with a P/E ratio of ${currentStock.pe}.</p>`;
            }
            
            // Price movement analysis
            if (currentStock.changePercent > 3) {
                summary += `<p class="mb-2 text-green-600">Strong positive momentum: Up ${currentStock.changePercent.toFixed(2)}% today.</p>`;
            } else if (currentStock.changePercent < -3) {
                summary += `<p class="mb-2 text-red-600">Negative momentum: Down ${Math.abs(currentStock.changePercent).toFixed(2)}% today.</p>`;
            }
            
            // Volume analysis
            if (currentStock.volume > 500000) {
                summary += `<p class="mb-2">High trading volume (${currentStock.volume.toLocaleString()}) indicates strong investor interest.</p>`;
            }
            
            // Final recommendation
            if (currentStock.score > 80) {
                summary += `<p class="mt-4 font-medium text-green-600">Recommendation: <span class="font-bold">Strong buy</span> candidate (Score: ${currentStock.score}/100)</p>`;
            } else if (currentStock.score > 60) {
                summary += `<p class="mt-4 font-medium text-yellow-600">Recommendation: <span class="font-bold">Potential buy</span> (Score: ${currentStock.score}/100)</p>`;
            } else {
                summary += `<p class="mt-4 font-medium text-red-600">Recommendation: <span class="font-bold">Caution advised</span> (Score: ${currentStock.score}/100)</p>`;
            }
            
            document.getElementById('analysisSummary').innerHTML = summary;
        }

        // Show the table view
        function showTableView() {
            document.getElementById('tableView').classList.remove('hidden');
            document.getElementById('detailView').classList.add('hidden');
        }
    </script>
</body>
</html>
