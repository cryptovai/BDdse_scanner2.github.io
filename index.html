<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Stock Screener - Real-Time বাংলাদেশ স্টক মার্কেট বিশ্লেষণ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        th:hover {
            background-color: #f1f5f9;
        }
        .sort-asc::after {
            content: " ↑";
        }
        .sort-desc::after {
            content: " ↓";
        }
        .bangla-text {
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .sector-btn {
            transition: all 0.2s;
        }
        .sector-btn:hover {
            transform: translateY(-1px);
        }
        .sector-btn.active {
            background-color: #1d4ed8;
            color: white;
        }
        .blink {
            animation: blink-animation 1s steps(2, start) infinite;
        }
        @keyframes blink-animation {
            to { visibility: hidden; }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="fetchStockData()" class="flex items-center bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
                <h1 class="text-xl font-bold">DSE Real-Time Stock Screener</h1>
                <span id="liveBadge" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full blink">LIVE</span>
            </div>
            <div>
                <p class="text-blue-200 text-sm">বাংলাদেশ স্টক মার্কেট বিশ্লেষণ By Adnan Sayem</p>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Lightweight Loading Placeholder -->
        <div id="loadingPlaceholder" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-500">রিয়েল-টাইম ডেটা লোড হচ্ছে...</p>
        </div>

        <!-- Sector Filter -->
        <div id="sectorFilter" class="hidden mb-4">
            <div class="flex flex-wrap gap-2">
                <button onclick="filterBySector('all')" class="sector-btn active bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                    সব সেক্টর
                </button>
                <!-- Filled by JavaScript -->
            </div>
        </div>

        <!-- Main Table View -->
        <div id="tableView" class="mb-8 hidden">
            <div class="card overflow-hidden mb-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('ticker')">Ticker</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('sector')">Sector</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('ltp')">Price (BDT)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('change')">Change%</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('volume')">Volume</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('pe')">P/E</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100" onclick="sortTable('score')">Score</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Analysis</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed Stock View -->
        <div id="detailView" class="hidden">
            <!-- ... (keep your existing detail view structure) ... -->
        </div>
    </main>

    <footer class="bg-blue-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>এডনান সায়েমের স্টক বিশ্লেষণ &copy; ২০২৩ | সর্বশেষ আপডেট: <span id="updateTime"></span></p>
        </div>
    </footer>

    <script>
        // Global variables
        let allStocks = [];
        let filteredStocks = [];
        let currentSort = { key: 'score', order: 'desc' };
        let currentStock = null;
        let currentSector = 'all';
        let refreshInterval = 120000; // 2 minutes

        // DSE API Endpoints
        const DSE_API = {
            LIVE_DATA: "https://www.dse.com.bd/datafeed/current_price.php",
            ALL_COMPANIES: "https://www.dse.com.bd/datafeed/all_companies.php"
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('loadingPlaceholder').classList.remove('hidden');
            fetchStockData();
            
            // Auto-refresh
            setInterval(fetchStockData, refreshInterval);
        });

        // Fetch real-time stock data
        async function fetchStockData() {
            try {
                showLoading();
                
                // Fetch data from DSE
                const [priceData, companyData] = await Promise.all([
                    fetch(DSE_API.LIVE_DATA).then(res => res.json()),
                    fetch(DSE_API.ALL_COMPANIES).then(res => res.json())
                ]);

                // Process data
                allStocks = processRealTimeData(priceData, companyData);
                
                // Initialize UI
                initSectorFilter();
                filterBySector(currentSector);
                updateLastUpdatedTime();
                
                // Update UI
                document.getElementById('loadingPlaceholder').classList.add('hidden');
                document.getElementById('tableView').classList.remove('hidden');
                document.getElementById('sectorFilter').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error fetching real-time data:', error);
                showError("Failed to load real-time data. Trying again...");
                setTimeout(fetchStockData, 5000); // Retry after 5 seconds
            }
        }

        // Process real-time DSE data
        function processRealTimeData(priceData, companyData) {
            return priceData.map(stock => {
                const companyInfo = companyData.find(c => c.trading_code === stock.trading_code) || {};
                
                return {
                    ticker: stock.trading_code,
                    name: companyInfo.company_name || stock.trading_code,
                    sector: companyInfo.sector || 'Miscellaneous',
                    ltp: parseFloat(stock.ltp),
                    high: parseFloat(stock.high),
                    low: parseFloat(stock.low),
                    close: parseFloat(stock.closep),
                    ycp: parseFloat(stock.ycp),
                    change: parseFloat(stock.change),
                    changePercent: parseFloat(stock.change_percent),
                    trade: parseInt(stock.trade),
                    volume: parseInt(stock.volume),
                    value: parseFloat(stock.value),
                    pe: parseFloat(stock.pe) || calculatePeRatio(stock),
                    score: calculateDynamicScore(stock),
                    lastUpdated: new Date().toISOString()
                };
            });
        }

        // Calculate dynamic score
        function calculateDynamicScore(stock) {
            let score = 50; // Base score
            
            // Positive factors
            if (stock.change > 0) score += 15;
            if (stock.volume > 100000) score += 10;
            if (stock.changePercent > 2) score += 5;
            if (stock.pe < 15) score += 10;
            
            // Negative factors
            if (stock.change < -5) score -= 10;
            if (stock.pe > 25) score -= 5;
            
            return Math.max(0, Math.min(100, score));
        }

        // Calculate PE ratio if missing
        function calculatePeRatio(stock) {
            return stock.ycp ? (stock.ltp / stock.ycp).toFixed(2) : 0;
        }

        // Initialize sector filter buttons
        function initSectorFilter() {
            const sectorContainer = document.getElementById('sectorFilter').querySelector('div');
            sectorContainer.innerHTML = '';
            
            // Get all unique sectors
            const sectors = [...new Set(allStocks.map(stock => stock.sector))];
            
            // Add sector buttons
            sectors.forEach(sector => {
                const btn = document.createElement('button');
                btn.className = 'sector-btn bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                btn.textContent = sector;
                btn.onclick = () => filterBySector(sector);
                sectorContainer.appendChild(btn);
            });
        }

        // Render the main stock table with real-time data
        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            if (!tbody) return;

            // Sort stocks
            const sortedStocks = [...filteredStocks].sort((a, b) => {
                const aVal = a[currentSort.key];
                const bVal = b[currentSort.key];
                
                if (aVal === undefined || bVal === undefined) return 0;
                if (currentSort.order === 'asc') return aVal - bVal;
                return bVal - aVal;
            });

            // Efficient DOM updates
            let html = '';
            
            sortedStocks.forEach(stock => {
                const changeClass = stock.change >= 0 ? 'text-green-600' : 'text-red-600';
                const peColor = stock.pe < 15 ? 'text-green-600' : stock.pe < 25 ? 'text-yellow-600' : 'text-red-600';
                
                html += `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 whitespace-nowrap font-medium">${stock.ticker}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.sector}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.ltp.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap ${changeClass}">
                            ${stock.change >= 0 ? '+' : ''}${stock.change} (${stock.changePercent}%)
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.volume.toLocaleString()}</td>
                        <td class="px-4 py-3 whitespace-nowrap ${peColor}">${stock.pe}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-bold bg-blue-50">${stock.score}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <button onclick="showStockDetail('${stock.ticker}')" class="text-blue-600 hover:text-blue-800 text-sm">
                                বিশ্লেষণ
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Update sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('onclick')?.includes(`sortTable('${currentSort.key}')`)) {
                    th.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // ... (keep your existing helper functions like sortTable, filterBySector, etc) ...

        function showLoading() {
            document.getElementById('loadingPlaceholder').classList.remove('hidden');
            document.getElementById('tableView').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingPlaceholder').innerHTML = `
                <div class="bg-red-100 text-red-800 p-3 rounded">
                    ${message}
                    <button onclick="fetchStockData()" class="ml-2 bg-blue-500 text-white px-2 py-1 rounded text-sm">
                        Retry Now
                    </button>
                </div>
            `;
        }

        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleTimeString();
        }
    </script>
</body>
</html>
