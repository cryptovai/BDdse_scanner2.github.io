<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Real-Time Stock Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            transition: background-color 0.2s;
        }
        th:hover {
            background-color: #f1f5f9;
        }
        .sort-asc::after {
            content: " ↑";
        }
        .sort-desc::after {
            content: " ↓";
        }
        .connection-status {
            transition: all 0.3s ease;
        }
        .connection-live {
            background-color: #10B981; /* Green */
        }
        .connection-closed {
            background-color: #6B7280; /* Gray */
        }
        .connection-offline {
            background-color: #EF4444; /* Red */
        }
        .market-open {
            background-color: #D1FAE5; /* Light green */
            color: #065F46; /* Dark green */
        }
        .market-closed {
            background-color: #F3F4F6; /* Light gray */
            color: #4B5563; /* Dark gray */
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="fetchStockData()" class="flex items-center bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Refresh
                </button>
                <h1 class="text-xl font-bold">DSE Stock Screener</h1>
                <span id="connectionStatus" class="connection-status text-white text-xs px-2 py-1 rounded-full"></span>
            </div>
            <div>
                <p class="text-blue-200 text-sm">বাংলাদেশ স্টক মার্কেট বিশ্লেষণ By Adnan Sayem</p>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Market Status Banner -->
        <div id="marketStatusBanner" class="rounded-lg p-3 text-center font-medium mb-4 hidden"></div>

        <!-- Loading Placeholder -->
        <div id="loadingPlaceholder" class="text-center py-8 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-500">Loading market data...</p>
        </div>

        <!-- Sector Filter -->
        <div id="sectorFilter" class="hidden mb-4">
            <div class="flex flex-wrap gap-2">
                <button onclick="filterBySector('all')" class="sector-btn active bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                    All Sectors
                </button>
                <!-- Filled by JavaScript -->
            </div>
        </div>

        <!-- Main Table View -->
        <div id="tableView" class="mb-8 hidden">
            <div class="card overflow-hidden mb-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('ticker')">Ticker</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('sector')">Sector</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('ltp')">Price (BDT)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('change')">Change%</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('volume')">Volume</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('pe')">P/E</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100" onclick="sortTable('score')">Score</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Analysis</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-right text-xs text-gray-500">
                <span id="lastUpdated"></span>
                <span id="dataSource" class="ml-2"></span>
            </div>
        </div>

        <!-- Error Display -->
        <div id="errorDisplay" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4">
            <!-- Filled by JavaScript -->
        </div>
    </main>

    <script>
        // Global variables
        let allStocks = [];
        let filteredStocks = [];
        let currentSort = { key: 'score', order: 'desc' };
        let currentStock = null;
        let currentSector = 'all';
        const refreshInterval = 120000; // 2 minutes
        let retryCount = 0;
        const MAX_RETRIES = 3;
        let currentEndpointIndex = 0;
        let autoRefreshInterval;
        let isMarketOpen = true;
        let lastSuccessfulData = null;

        // DSE API Endpoints
        const DSE_API_ENDPOINTS = [
            "https://www.dse.com.bd/datafeed/current_price.php",
            "https://dse.com.bd/datafeed/current_price.php"
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkMarketStatus();
            initApp();
        });

        function checkMarketStatus() {
            const now = new Date();
            const bangladeshTime = new Date(now.getTime() + (6 * 60 * 60 * 1000)); // UTC+6
            const currentHour = bangladeshTime.getHours();
            const currentMinute = bangladeshTime.getMinutes();
            const dayOfWeek = bangladeshTime.getDay();
            
            // Market hours: Sunday-Thursday 9:00 AM to 2:30 PM Bangladesh time
            isMarketOpen = !(
                dayOfWeek === 5 || // Friday
                dayOfWeek === 6 || // Saturday
                currentHour < 9 || // Before 9 AM
                (currentHour === 14 && currentMinute >= 30) || // After 2:30 PM
                currentHour > 14 // After 2:59 PM
            );
            
            updateMarketStatusBanner();
        }

        function updateMarketStatusBanner() {
            const banner = document.getElementById('marketStatusBanner');
            banner.classList.remove('hidden', 'market-open', 'market-closed');
            
            if (isMarketOpen) {
                banner.classList.add('market-open');
                banner.textContent = "Market is OPEN - Live prices updating";
            } else {
                banner.classList.add('market-closed');
                banner.textContent = "Market is CLOSED - Showing last available prices";
            }
        }

        function initApp() {
            showLoading();
            setupAutoRefresh();
            fetchStockData();
        }

        function setupAutoRefresh() {
            clearInterval(autoRefreshInterval);
            if (isMarketOpen) {
                autoRefreshInterval = setInterval(fetchStockData, refreshInterval);
                updateConnectionStatus('live');
            } else {
                updateConnectionStatus('closed');
                if (lastSuccessfulData) {
                    useLastAvailableData();
                } else {
                    fetchStockData(); // Try to get data at least once
                }
            }
        }

        async function fetchStockData() {
            try {
                showLoading();
                
                const endpoint = DSE_API_ENDPOINTS[currentEndpointIndex];
                document.getElementById('dataSource').textContent = `Source: DSE ${currentEndpointIndex + 1}`;
                
                const response = await fetchWithTimeout(endpoint, 5000);
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error("Invalid data format received");
                }
                
                processMarketData(data);
                retryCount = 0;
                
            } catch (error) {
                console.error('Error fetching data:', error);
                handleDataError(error);
            }
        }

        function processMarketData(priceData) {
            allStocks = priceData.map(stock => {
                const changePercent = stock.change_percent || 
                    (stock.ycp ? ((stock.ltp - stock.ycp) / stock.ycp * 100) : 0);
                
                return {
                    ticker: stock.trading_code,
                    name: stock.trading_code, // Can be enhanced with company names
                    sector: 'General', // Can be enhanced with actual sectors
                    ltp: parseFloat(stock.ltp) || 0,
                    high: parseFloat(stock.high) || 0,
                    low: parseFloat(stock.low) || 0,
                    close: parseFloat(stock.closep) || 0,
                    ycp: parseFloat(stock.ycp) || 0,
                    change: parseFloat(stock.change) || 0,
                    changePercent: parseFloat(changePercent) || 0,
                    volume: parseInt(stock.volume) || 0,
                    pe: parseFloat(stock.pe) || 0,
                    score: calculateDynamicScore(stock),
                    lastUpdated: new Date().toISOString()
                };
            });
            
            lastSuccessfulData = allStocks;
            updateUI();
            updateConnectionStatus(isMarketOpen ? 'live' : 'closed');
        }

        function calculateDynamicScore(stock) {
            let score = 50; // Base score
            
            // Positive factors
            if (stock.change > 0) score += 15;
            if (stock.volume > 100000) score += 10;
            if (stock.changePercent > 2) score += 5;
            if (stock.pe < 15) score += 10;
            
            // Negative factors
            if (stock.change < -5) score -= 10;
            if (stock.pe > 25) score -= 5;
            
            return Math.max(0, Math.min(100, score));
        }

        function useLastAvailableData() {
            if (lastSuccessfulData) {
                allStocks = lastSuccessfulData;
                updateUI();
                updateConnectionStatus('closed');
            }
        }

        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.classList.remove('connection-live', 'connection-closed', 'connection-offline');
            
            switch(status) {
                case 'live':
                    statusElement.classList.add('connection-live');
                    statusElement.textContent = "LIVE";
                    break;
                case 'closed':
                    statusElement.classList.add('connection-closed');
                    statusElement.textContent = "CLOSED";
                    break;
                case 'offline':
                    statusElement.classList.add('connection-offline');
                    statusElement.textContent = "OFFLINE";
                    break;
            }
        }

        function updateUI() {
            initSectorFilter();
            filterBySector(currentSector);
            
            document.getElementById('loadingPlaceholder').classList.add('hidden');
            document.getElementById('errorDisplay').classList.add('hidden');
            document.getElementById('tableView').classList.remove('hidden');
            document.getElementById('marketStatusBanner').classList.remove('hidden');
            
            document.getElementById('lastUpdated').textContent = `Last update: ${new Date().toLocaleTimeString()}`;
        }

        function showLoading() {
            document.getElementById('loadingPlaceholder').classList.remove('hidden');
            document.getElementById('tableView').classList.add('hidden');
            document.getElementById('errorDisplay').classList.add('hidden');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            errorDiv.classList.remove('hidden');
            errorDiv.innerHTML = `
                <div class="flex items-center">
                    <svg class="h-5 w-5 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <strong>Error:</strong>
                </div>
                <p class="mt-1">${message}</p>
                <button onclick="forceRetry()" class="mt-2 bg-blue-500 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                    Retry Now
                </button>
            `;
            
            document.getElementById('loadingPlaceholder').classList.add('hidden');
            updateConnectionStatus('offline');
        }

        function forceRetry() {
            retryCount = 0;
            fetchStockData();
        }

        function initSectorFilter() {
            const sectorContainer = document.getElementById('sectorFilter').querySelector('div');
            sectorContainer.innerHTML = '';
            
            // Simplified sector filtering - can be enhanced with actual sectors
            const sectors = ['All', 'Bank', 'Pharma', 'Fuel & Power', 'IT'];
            
            sectors.forEach(sector => {
                const btn = document.createElement('button');
                btn.className = 'sector-btn bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm';
                btn.textContent = sector;
                btn.onclick = () => filterBySector(sector === 'All' ? 'all' : sector);
                sectorContainer.appendChild(btn);
            });
            
            document.getElementById('sectorFilter').classList.remove('hidden');
        }

        function filterBySector(sector) {
            currentSector = sector;
            
            document.querySelectorAll('.sector-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-600', 'text-white');
                btn.classList.add('bg-blue-100', 'text-blue-800');
            });
            
            if (sector === 'all') {
                filteredStocks = [...allStocks];
                document.querySelector('.sector-btn').classList.add('active', 'bg-blue-600', 'text-white');
            } else {
                filteredStocks = allStocks; // Simplified - would filter by actual sector if data available
                document.querySelectorAll('.sector-btn').forEach(btn => {
                    if (btn.textContent === sector) {
                        btn.classList.add('active', 'bg-blue-600', 'text-white');
                    }
                });
            }
            
            renderStockTable();
        }

        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            
            const sortedStocks = [...filteredStocks].sort((a, b) => {
                const aVal = a[currentSort.key];
                const bVal = b[currentSort.key];
                return currentSort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            sortedStocks.forEach(stock => {
                const changeClass = stock.change >= 0 ? 'text-green-600' : 'text-red-600';
                const peColor = stock.pe < 15 ? 'text-green-600' : stock.pe < 25 ? 'text-yellow-600' : 'text-red-600';
                const scoreColor = stock.score > 75 ? 'text-green-600' : stock.score > 50 ? 'text-yellow-600' : 'text-red-600';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap font-medium">${stock.ticker}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${stock.sector}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${stock.ltp.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap ${changeClass}">
                        ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">${stock.volume.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap ${peColor}">${stock.pe.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-bold ${scoreColor}">${stock.score}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <button onclick="showStockDetail('${stock.ticker}')" class="text-blue-600 hover:text-blue-800 text-sm">
                            Analyze
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function sortTable(key) {
            if (currentSort.key === key) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.order = 'desc';
            }
            renderStockTable();
        }

        async function fetchWithTimeout(resource, timeout = 5000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            
            const response = await fetch(resource, {
                signal: controller.signal,
                cache: 'no-store'
            });
            clearTimeout(id);
            return response;
        }

        function showStockDetail(ticker) {
            // Implementation for detailed view would go here
            alert(`Detailed analysis for ${ticker} would appear here`);
        }
    </script>
</body>
</html>
