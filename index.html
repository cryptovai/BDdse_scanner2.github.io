<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Stock Screener</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
        }
        .chart-container {
            height: 400px;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .loading-spinner {
            border: 4px solid rgba(0,0,0,0.1);
            border-top: 4px solid #1976D2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-2xl font-bold">DSE Stock Screener</h1>
            <p class="text-blue-200">Comprehensive Bangladesh Market Analysis</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <section class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="card p-4 text-center">
                    <h3 class="text-blue-900 font-medium">Total Companies</h3>
                    <p class="text-2xl font-bold" id="totalCompanies">-</p>
                </div>
                <div class="card p-4 text-center">
                    <h3 class="text-blue-900 font-medium">Top Sector</h3>
                    <p class="text-2xl font-bold" id="topSector">-</p>
                </div>
                <div class="card p-4 text-center">
                    <h3 class="text-blue-900 font-medium">Avg. P/E Ratio</h3>
                    <p class="text-2xl font-bold" id="avgPeRatio">-</p>
                </div>
            </div>
            <p class="text-right text-sm text-gray-500" id="lastUpdated">Loading data...</p>
        </section>

        <section class="mb-8">
            <div class="card p-6">
                <h2 class="text-2xl font-bold text-blue-800 mb-4">Stock Data</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead>
                            <tr class="border-b-2 border-blue-500">
                                <th class="p-3 text-left cursor-pointer" onclick="sortTable('ticker')">Ticker</th>
                                <th class="p-3 text-left cursor-pointer" onclick="sortTable('sector')">Sector</th>
                                <th class="p-3 text-left cursor-pointer" onclick="sortTable('peRatio')">P/E</th>
                                <th class="p-3 text-left cursor-pointer" onclick="sortTable('roe')">ROE</th>
                                <th class="p-3 text-left cursor-pointer" onclick="sortTable('debtToEquity')">D/E</th>
                                <th class="p-3 text-left cursor-pointer" onclick="sortTable('marketCap')">Market Cap</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <div class="loading-spinner"></div>
                                    <p>Loading stock data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="card p-6">
                <h2 class="text-xl font-bold text-blue-800 mb-4">ROE vs Debt/Equity</h2>
                <div class="chart-container">
                    <canvas id="roeDebtChart"></canvas>
                </div>
            </div>
            <div class="card p-6">
                <h2 class="text-xl font-bold text-blue-800 mb-4">Top Performers</h2>
                <div class="chart-container">
                    <canvas id="topPerformersChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <footer class="bg-blue-900 text-white py-6">
        <div class="container mx-auto px-4 text-center">
            <p>DSE Stock Screener &copy; 2023 | Data updated: <span id="footerUpdateTime"></span></p>
        </div>
    </footer>

    <script>
        // Sample data - replace with real API call
        const sampleData = [
            { ticker: "GP", sector: "Telecom", peRatio: 15.5, roe: 22.6, debtToEquity: 0.41, marketCap: 500000000 },
            { ticker: "ACI", sector: "Pharma", peRatio: 14.7, roe: 42.0, debtToEquity: 0.11, marketCap: 450000000 },
            { ticker: "BATBC", sector: "Tobacco", peRatio: 9.8, roe: 74.3, debtToEquity: 1.37, marketCap: 600000000 }
        ];

        // Chart instances
        let roeDebtChart, topPerformersChart;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            initCharts();
            updateUI();
        });

        function loadData() {
            // In a real app, you would fetch from an API or CSV
            // For now, we'll use sample data with a delay to simulate loading
            setTimeout(() => {
                processData(sampleData);
            }, 1000);
        }

        function processData(data) {
            // Calculate any derived fields
            data.forEach(stock => {
                stock.marketCapFormatted = formatMarketCap(stock.marketCap);
            });
            
            // Update the table
            renderTable(data);
            
            // Update summary stats
            updateSummaryStats(data);
            
            // Update charts
            updateCharts(data);
            
            // Set last updated time
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleString()}`;
            document.getElementById('footerUpdateTime').textContent = now.toLocaleDateString();
        }

        function renderTable(data) {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            
            data.forEach(stock => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-blue-50';
                row.innerHTML = `
                    <td class="p-3 font-medium">${stock.ticker}</td>
                    <td class="p-3">${stock.sector}</td>
                    <td class="p-3">${stock.peRatio.toFixed(1)}</td>
                    <td class="p-3">${stock.roe.toFixed(1)}%</td>
                    <td class="p-3">${stock.debtToEquity.toFixed(2)}</td>
                    <td class="p-3">${stock.marketCapFormatted}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSummaryStats(data) {
            document.getElementById('totalCompanies').textContent = data.length;
            
            // Find most common sector
            const sectors = {};
            data.forEach(stock => {
                sectors[stock.sector] = (sectors[stock.sector] || 0) + 1;
            });
            const topSector = Object.keys(sectors).reduce((a, b) => sectors[a] > sectors[b] ? a : b);
            document.getElementById('topSector').textContent = topSector;
            
            // Calculate average P/E
            const avgPE = data.reduce((sum, stock) => sum + stock.peRatio, 0) / data.length;
            document.getElementById('avgPeRatio').textContent = avgPE.toFixed(1);
        }

        function initCharts() {
            // ROE vs Debt/Equity Chart
            roeDebtChart = new Chart(
                document.getElementById('roeDebtChart'),
                {
                    type: 'scatter',
                    data: {
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Return on Equity (%)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Debt to Equity Ratio'
                                }
                            }
                        }
                    }
                }
            );
            
            // Top Performers Chart
            topPerformersChart = new Chart(
                document.getElementById('topPerformersChart'),
                {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'ROE (%)',
                            data: [],
                            backgroundColor: '#42A5F5'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        scales: {
                            x: {
                                beginAtZero: true
                            }
                        }
                    }
                }
            );
        }

        function updateCharts(data) {
            // Update ROE vs Debt chart
            roeDebtChart.data.datasets = [{
                label: 'Companies',
                data: data.map(stock => ({
                    x: stock.roe,
                    y: stock.debtToEquity,
                    r: Math.sqrt(stock.marketCap) / 1000
                })),
                backgroundColor: '#0D47A1'
            }];
            roeDebtChart.update();
            
            // Update Top Performers chart (top 5 by ROE)
            const top5 = [...data].sort((a, b) => b.roe - a.roe).slice(0, 5);
            topPerformersChart.data.labels = top5.map(stock => stock.ticker);
            topPerformersChart.data.datasets[0].data = top5.map(stock => stock.roe);
            topPerformersChart.update();
        }

        function sortTable(column) {
            // Simple sorting functionality
            const tbody = document.getElementById('stockTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const aVal = a.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent;
                const bVal = b.querySelector(`td:nth-child(${getColumnIndex(column)})`).textContent;
                return isNaN(aVal) ? aVal.localeCompare(bVal) : parseFloat(aVal) - parseFloat(bVal);
            });
            
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function getColumnIndex(column) {
            const columns = ['ticker', 'sector', 'peRatio', 'roe', 'debtToEquity', 'marketCap'];
            return columns.indexOf(column) + 1;
        }

        function formatMarketCap(value) {
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(2) + 'B';
            }
            if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            }
            return value.toString();
        }
    </script>
</body>
</html>
