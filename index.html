<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Real-Time Stock Screener with DeepSeek AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Previous styles remain the same */
        .ai-panel {
            transition: all 0.3s ease;
            max-height: 0;
            overflow: hidden;
        }
        .ai-panel.open {
            max-height: 500px;
        }
        .ai-response {
            white-space: pre-wrap;
        }
        .typing-indicator::after {
            content: '...';
            animation: typing 1.5s infinite;
        }
        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Previous header remains the same -->
    <header class="bg-blue-800 text-white shadow-lg">
        <!-- ... -->
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Previous elements remain the same -->
        <!-- Market Status Banner -->
        <!-- Loading Placeholder -->
        <!-- Sector Filter -->
        <!-- Main Table View -->
        <!-- Error Display -->

        <!-- New AI Analysis Panel -->
        <div id="aiPanel" class="ai-panel card mt-6">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="font-bold text-lg">DeepSeek AI Stock Analysis</h3>
                <button id="closeAIPanel" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="p-4">
                <div id="aiResponse" class="ai-response bg-gray-50 p-3 rounded mb-4 min-h-32 max-h-96 overflow-y-auto"></div>
                <div class="flex space-x-2">
                    <select id="aiPromptSelect" class="flex-grow border border-gray-300 rounded px-3 py-2">
                        <option value="">Select a question...</option>
                        <option value="trend">What are today's market trends?</option>
                        <option value="topPerformers">Which stocks are performing best today?</option>
                        <option value="undervalued">Which stocks appear undervalued?</option>
                        <option value="sector">Analyze sector performance</option>
                        <option value="custom">Custom question...</option>
                    </select>
                    <button id="askAI" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        Ask AI
                    </button>
                </div>
                <div id="customPromptContainer" class="mt-2 hidden">
                    <textarea id="customPrompt" class="w-full border border-gray-300 rounded px-3 py-2" placeholder="Ask your custom question about the market..."></textarea>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Previous global variables remain the same
        // Add new AI-related variables
        let aiPanelOpen = false;
        const AI_RESPONSE_EXAMPLES = {
            trend: `Market Analysis (${new Date().toLocaleDateString()}):
            
            - Overall market is showing mixed trends today
            - Banking sector is up by 1.2% on average
            - Pharmaceutical stocks are slightly down (-0.5%)
            - High trading volume observed in IT sector
            
            Key Observations:
            • ABC Bank leading gains (+3.2%)
            • XYZ Pharma facing sell pressure (-2.1%)
            • Market sentiment appears cautious ahead of earnings season`,
            
            topPerformers: `Today's Top Performers:
            
            1. ABCL (ABC Limited) +5.2%
               - Breaking resistance at ৳120
               - Volume 3x average
               - Strong institutional buying
            
            2. DEFM (DEF Manufacturing) +4.8%
               - Positive earnings preview
               - Sector outlook improved
            
            3. GHI Bank +3.9%
               - Dividend announcement expected
               - Technical breakout pattern`,
            
            undervalued: `Potential Undervalued Stocks:
            
            • JKL Pharma (PE 12.3 vs sector avg 18.2)
              - Strong pipeline, recent FDA approval
              - Technical indicators show accumulation
            
            • MNO Textiles (PE 8.7)
              - Export orders up 15% QoQ
              - Dividend yield 5.2%
            
            • PQR Power (PE 9.1)
              - Government infrastructure projects
              - Price below book value`,
            
            sector: `Sector Performance Analysis:
            
            Banking Sector: ▲1.5%
            - Interest rate stability
            - NPL ratios improving
            
            Pharmaceuticals: ▼0.8%
            - Regulatory concerns
            - Export challenges
            
            IT Sector: ▲2.3%
            - Digital transformation demand
            - New outsourcing contracts`
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            checkMarketStatus();
            initApp();
            setupAI();
        });

        // Previous functions remain the same until renderStockTable()

        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            tbody.innerHTML = '';
            
            const sortedStocks = [...filteredStocks].sort((a, b) => {
                const aVal = a[currentSort.key];
                const bVal = b[currentSort.key];
                return currentSort.order === 'asc' ? aVal - bVal : bVal - aVal;
            });
            
            sortedStocks.forEach(stock => {
                const changeClass = stock.change >= 0 ? 'text-green-600' : 'text-red-600';
                const peColor = stock.pe < 15 ? 'text-green-600' : stock.pe < 25 ? 'text-yellow-600' : 'text-red-600';
                const scoreColor = stock.score > 75 ? 'text-green-600' : stock.score > 50 ? 'text-yellow-600' : 'text-red-600';
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap font-medium">${stock.ticker}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${stock.sector}</td>
                    <td class="px-4 py-3 whitespace-nowrap">${stock.ltp.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap ${changeClass}">
                        ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">${stock.volume.toLocaleString()}</td>
                    <td class="px-4 py-3 whitespace-nowrap ${peColor}">${stock.pe.toFixed(2)}</td>
                    <td class="px-4 py-3 whitespace-nowrap font-bold ${scoreColor}">${stock.score}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <button onclick="analyzeStock('${stock.ticker}')" class="text-blue-600 hover:text-blue-800 text-sm">
                            Analyze
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // New AI-related functions
        function setupAI() {
            // Toggle AI panel
            document.getElementById('closeAIPanel').addEventListener('click', () => {
                toggleAIPanel(false);
            });

            // Prompt selection
            document.getElementById('aiPromptSelect').addEventListener('change', (e) => {
                const value = e.target.value;
                const customContainer = document.getElementById('customPromptContainer');
                customContainer.classList.toggle('hidden', value !== 'custom');
            });

            // Ask AI button
            document.getElementById('askAI').addEventListener('click', askAIQuestion);
        }

        function toggleAIPanel(open) {
            aiPanelOpen = open !== undefined ? open : !aiPanelOpen;
            const panel = document.getElementById('aiPanel');
            panel.classList.toggle('open', aiPanelOpen);
        }

        function analyzeStock(ticker) {
            toggleAIPanel(true);
            const stock = allStocks.find(s => s.ticker === ticker);
            if (!stock) return;

            const responseArea = document.getElementById('aiResponse');
            responseArea.innerHTML = '<div class="typing-indicator">Analyzing stock data</div>';
            
            // Simulate AI analysis (in a real app, this would call an API)
            setTimeout(() => {
                const analysis = generateStockAnalysis(stock);
                responseArea.innerHTML = `
                    <h4 class="font-bold mb-2">${stock.ticker} Analysis</h4>
                    <div class="space-y-2">
                        ${analysis.split('\n').map(line => `<p>${line}</p>`).join('')}
                    </div>
                `;
            }, 1500);
        }

        function askAIQuestion() {
            const promptSelect = document.getElementById('aiPromptSelect');
            const customPrompt = document.getElementById('customPrompt');
            const responseArea = document.getElementById('aiResponse');
            
            let question = promptSelect.value;
            if (question === 'custom') {
                question = customPrompt.value.trim();
                if (!question) {
                    alert('Please enter your question');
                    return;
                }
            } else if (!question) {
                alert('Please select a question');
                return;
            }
            
            responseArea.innerHTML = '<div class="typing-indicator">Analyzing market data</div>';
            toggleAIPanel(true);
            
            // Simulate AI response (in a real app, this would call an API)
            setTimeout(() => {
                const response = generateAIResponse(question);
                responseArea.innerHTML = `
                    <div class="space-y-3">
                        ${response.split('\n').map(line => `<p>${line || '<br>'}</p>`).join('')}
                    </div>
                `;
            }, 2000);
        }

        function generateStockAnalysis(stock) {
            const performance = stock.changePercent >= 2 ? 'strong' : 
                              stock.changePercent <= -2 ? 'weak' : 'neutral';
            const valuation = stock.pe < 12 ? 'undervalued' :
                            stock.pe > 25 ? 'overvalued' : 'fairly valued';
            const volumeAnalysis = stock.volume > 500000 ? 'high' :
                                  stock.volume > 100000 ? 'moderate' : 'low';
            
            return `Stock: ${stock.ticker}
Current Price: ৳${stock.ltp.toFixed(2)}
Change: ${stock.change >= 0 ? '+' : ''}${stock.change.toFixed(2)} (${stock.changePercent.toFixed(2)}%)
Volume: ${stock.volume.toLocaleString()}
P/E Ratio: ${stock.pe.toFixed(2)}

Performance Analysis:
- ${performance} performance today
- ${valuation} based on P/E ratio
- ${volumeAnalysis} trading volume

Technical Outlook:
- ${stock.score > 75 ? 'Bullish indicators' : stock.score < 40 ? 'Bearish indicators' : 'Neutral indicators'}
- ${stock.changePercent > 0 && stock.volume > 100000 ? 'Positive momentum' : 'Caution advised'}

Recommendation:
${stock.score > 70 ? 'Consider for investment' : stock.score < 40 ? 'Approach with caution' : 'Neutral outlook'}`;
        }

        function generateAIResponse(questionType) {
            if (AI_RESPONSE_EXAMPLES[questionType]) {
                return AI_RESPONSE_EXAMPLES[questionType];
            }
            
            return `AI Analysis for: ${questionType}
            
Based on current market data and technical indicators, here's my assessment:

1. Market sentiment appears mixed today with sector rotation evident
2. Banking stocks showing resilience despite interest rate concerns
3. Foreign participation remains limited affecting liquidity

Key Observations:
• Volatility expected to continue in near term
• Earnings season may provide new catalysts
• Technical support levels holding for most blue chips

Note: This is simulated AI analysis. In a real application, this would connect to DeepSeek's API for actual AI-powered insights.`;
        }

        // Previous utility functions remain the same
    </script>
</body>
</html>
