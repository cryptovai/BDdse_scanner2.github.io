<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSE Stock Screener -বাংলাদেশ স্টক মার্কেট বিশ্লেষণ by Adnan Sayem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th {
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        th:hover {
            background-color: #f1f5f9;
        }
        .sort-asc::after {
            content: " ↑";
        }
        .sort-desc::after {
            content: " ↓";
        }
        .chart-container {
            height: 400px;
        }
        .bangla-text {
            font-family: 'Helvetica', 'Arial', sans-serif;
        }
        .tradingview-widget-container {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="fetchStockData()" class="flex items-center bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Refresh
                </button>
                <h1 class="text-xl font-bold">DSE Stock Screener</h1>
            </div>
            <div>
                <p class="text-blue-200 text-sm">এডনান সায়েমের বাংলাদেশ স্টক মার্কেট বিশ্লেষণ</p>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- Lightweight Loading Placeholder -->
        <div id="loadingPlaceholder" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
            <p class="mt-2 text-gray-500">প্রাথমিক ডেটা লোড হচ্ছে...</p>
        </div>

        <!-- Main Table View -->
        <div id="tableView" class="mb-8 hidden">
            <div class="card overflow-hidden mb-4">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('ticker')">Ticker</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('category')">Category</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('faceValue')">Face Value</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('revenueCAGR5Y')">Revenue CAGR 5Y</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('netProfitCAGR5Y')">Net Profit CAGR 5Y</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" onclick="sortTable('overvalued52W')">Overvalued 52W</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-100" onclick="sortTable('totalScore')">Score</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Filled by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Detailed Stock View -->
        <div id="detailView" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <button onclick="showTableView()" class="flex items-center text-blue-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9.707 14.707a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 1.414L7.414 9H15a1 1 0 110 2H7.414l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                    </svg>
                    সব স্টকে ফিরে যান
                </button>
                <h2 id="detailStockName" class="text-xl font-bold text-gray-800"></h2>
                <div class="w-5"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Key Metrics Card -->
                <div class="card p-4">
                    <h3 class="font-medium text-gray-700 mb-3">মূল মেট্রিক্স</h3>
                    <div class="space-y-2" id="keyMetrics">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <!-- Growth Metrics Card -->
                <div class="card p-4">
                    <h3 class="font-medium text-gray-700 mb-3">গ্রোথ মেট্রিক্স</h3>
                    <div class="space-y-2" id="growthMetrics">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>

                <!-- Valuation Card -->
                <div class="card p-4">
                    <h3 class="font-medium text-gray-700 mb-3">ভ্যালুয়েশন</h3>
                    <div class="space-y-2" id="valuationMetrics">
                        <!-- Filled by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- TradingView Chart -->
            <div class="card p-4 mb-6">
                <h3 class="font-medium text-gray-700 mb-3">মূল্য পারফরম্যান্স</h3>
                <div class="chart-container">
                    <div class="tradingview-widget-container">
                        <div id="tradingview-chart" style="height: 100%;"></div>
                    </div>
                </div>
            </div>

            <!-- Analysis Summary -->
            <div class="card p-4 mb-6">
                <h3 class="font-medium text-gray-700 mb-3">বিশ্লেষণ ও সুপারিশ</h3>
                <div id="analysisSummary" class="text-gray-700 bangla-text">
                    <!-- Filled by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-blue-800 text-white py-4 mt-8">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>এডনান সায়েমের স্টক বিশ্লেষণ &copy; ২০২৩ | সর্বশেষ আপডেট: <span id="updateTime"></span></p>
        </div>
    </footer>

    <!-- TradingView Script (loaded only when needed) -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // Global variables
        let allStocks = [];
        let currentSort = { key: 'totalScore', order: 'desc' };
        let currentStock = null;
        let tvWidget = null;

        // Initialize the application with lightweight first load
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading placeholder immediately
            document.getElementById('loadingPlaceholder').classList.remove('hidden');
            
            // Load minimal data first
            setTimeout(() => {
                fetchStockData();
            }, 100);
        });

        // Fetch stock data (optimized)
        async function fetchStockData() {
            try {
                // Show loading state
                document.getElementById('loadingPlaceholder').classList.remove('hidden');
                document.getElementById('tableView').classList.add('hidden');
                document.getElementById('detailView').classList.add('hidden');
                
                // Simulated fast data load (replace with actual API call)
                allStocks = generateSimulatedData();
                
                // Render table immediately
                renderStockTable();
                updateLastUpdatedTime();
                
                // Hide loading and show table
                document.getElementById('loadingPlaceholder').classList.add('hidden');
                document.getElementById('tableView').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error fetching stock data:', error);
                document.getElementById('loadingPlaceholder').innerHTML = `
                    <p class="text-red-500">ডেটা লোড করতে সমস্যা হয়েছে। Refresh বাটনে ক্লিক করুন।</p>
                `;
            }
        }

        // Generate optimized simulated data
        function generateSimulatedData() {
            const categories = ['Bank', 'Pharma', 'Telecom', 'Fuel', 'IT', 'Food', 'Insurance', 'Textile'];
            const faceValues = [10, 100, 50, 20, 10, 100, 10, 50]; // Common face values in BDT
            
            const stocks = [];
            const sampleStocks = [
                { ticker: 'GP', name: 'গ্রামীণফোন লিমিটেড', category: 'Telecom' },
                { ticker: 'SQURPHARMA', name: 'স্কয়ার ফার্মাসিউটিক্যালস', category: 'Pharma' },
                { ticker: 'BATBC', name: 'ব্রিটিশ আমেরিকান টোব্যাকো', category: 'Food' },
                { ticker: 'ACI', name: 'এসি আই লিমিটেড', category: 'Conglomerate' },
                { ticker: 'BEXIMCO', name: 'বেক্সিমকো লিমিটেড', category: 'Textile' },
                { ticker: 'RENATA', name: 'রেনাটা লিমিটেড', category: 'Pharma' },
                { ticker: 'ISLAMIBANK', name: 'ইসলামী ব্যাংক বাংলাদেশ', category: 'Bank' },
                { ticker: 'SUMITPOWER', name: 'সামিট পাওয়ার', category: 'Power' }
            ];

            sampleStocks.forEach((stock, index) => {
                const categoryIndex = categories.indexOf(stock.category);
                const faceValue = faceValues[categoryIndex >= 0 ? categoryIndex : 0];
                
                stocks.push({
                    ...stock,
                    faceValue: faceValue,
                    revenueCAGR5Y: (Math.random() * 25 - 5).toFixed(2),
                    netProfitCAGR5Y: (Math.random() * 30 - 5).toFixed(2),
                    overvalued52W: (Math.random() * 60 - 30).toFixed(2),
                    freeFloatMarketCap: (Math.random() * 500 + 50).toFixed(2),
                    roe: (Math.random() * 30 + 5).toFixed(2),
                    roce: (Math.random() * 35 + 5).toFixed(2),
                    debtToEquity: (Math.random() * 2).toFixed(2),
                    peRatio: (Math.random() * 40 + 5).toFixed(2),
                    pbRatio: (Math.random() * 5 + 0.5).toFixed(2),
                    directorHoldings: (Math.random() * 80 + 10).toFixed(2),
                    totalScore: Math.floor(Math.random() * 100 + 50),
                    lastPrice: (Math.random() * 500 + 50).toFixed(2)
                });
            });

            return stocks;
        }

        // Render the main stock table (optimized)
        function renderStockTable() {
            const tbody = document.getElementById('stockTableBody');
            if (!tbody) return;

            // Sort stocks
            const sortedStocks = [...allStocks].sort((a, b) => {
                const aVal = a[currentSort.key];
                const bVal = b[currentSort.key];
                
                if (aVal === undefined || bVal === undefined) return 0;
                if (currentSort.order === 'asc') return aVal - bVal;
                return bVal - aVal;
            });

            // Efficient DOM updates
            let html = '';
            
            sortedStocks.forEach(stock => {
                const revenueColor = stock.revenueCAGR5Y > 10 ? 'text-green-600' : stock.revenueCAGR5Y > 0 ? 'text-yellow-600' : 'text-red-600';
                const profitColor = stock.netProfitCAGR5Y > 10 ? 'text-green-600' : stock.netProfitCAGR5Y > 0 ? 'text-yellow-600' : 'text-red-600';
                const overvaluedColor = stock.overvalued52W > 20 ? 'text-red-600' : stock.overvalued52W > 0 ? 'text-yellow-600' : 'text-green-600';
                
                html += `
                    <tr class="hover:bg-gray-50 cursor-pointer" onclick="showStockDetail('${stock.ticker}')">
                        <td class="px-4 py-3 whitespace-nowrap font-medium">${stock.ticker}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.category}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${stock.faceValue}</td>
                        <td class="px-4 py-3 whitespace-nowrap ${revenueColor}">${stock.revenueCAGR5Y}%</td>
                        <td class="px-4 py-3 whitespace-nowrap ${profitColor}">${stock.netProfitCAGR5Y}%</td>
                        <td class="px-4 py-3 whitespace-nowrap ${overvaluedColor}">${stock.overvalued52W}%</td>
                        <td class="px-4 py-3 whitespace-nowrap font-bold bg-blue-50">${stock.totalScore}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;

            // Update sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.getAttribute('onclick')?.includes(`sortTable('${currentSort.key}')`)) {
                    th.classList.add(currentSort.order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Sort table by column
        function sortTable(key) {
            if (currentSort.key === key) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.key = key;
                currentSort.order = 'desc';
            }
            renderStockTable();
        }

        // Show detailed view for a stock
        function showStockDetail(ticker) {
            currentStock = allStocks.find(s => s.ticker === ticker);
            if (!currentStock) return;

            document.getElementById('tableView').classList.add('hidden');
            document.getElementById('detailView').classList.remove('hidden');
            document.getElementById('detailStockName').textContent = `${currentStock.ticker} - ${currentStock.name}`;

            // Update key metrics
            document.getElementById('keyMetrics').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">শ্রেণী:</span>
                    <span class="font-medium">${currentStock.category}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">ফেস ভ্যালু:</span>
                    <span class="font-medium">${currentStock.faceValue} TK</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">ফ্রি ফ্লোট বাজারমূল্য:</span>
                    <span class="font-medium">${parseFloat(currentStock.freeFloatMarketCap).toFixed(2)}M</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">পরিচালকদের মালিকানা:</span>
                    <span class="font-medium">${currentStock.directorHoldings}%</span>
                </div>
            `;

            // Update growth metrics
            document.getElementById('growthMetrics').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">রেভিনিউ CAGR 5Y:</span>
                    <span class="font-medium ${currentStock.revenueCAGR5Y > 10 ? 'text-green-600' : 'text-red-600'}">${currentStock.revenueCAGR5Y}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">নেট লাভ CAGR 5Y:</span>
                    <span class="font-medium ${currentStock.netProfitCAGR5Y > 10 ? 'text-green-600' : 'text-red-600'}">${currentStock.netProfitCAGR5Y}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">৫২ সপ্তাহের সর্বনিম্ন থেকে:</span>
                    <span class="font-medium ${currentStock.overvalued52W > 20 ? 'text-red-600' : 'text-green-600'}">${currentStock.overvalued52W}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">ROE:</span>
                    <span class="font-medium">${currentStock.roe}%</span>
                </div>
            `;

            // Update valuation metrics
            document.getElementById('valuationMetrics').innerHTML = `
                <div class="flex justify-between">
                    <span class="text-gray-600">P/E Ratio:</span>
                    <span class="font-medium">${currentStock.peRatio}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">P/B Ratio:</span>
                    <span class="font-medium">${currentStock.pbRatio}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">মূল্য/ফেস ভ্যালু:</span>
                    <span class="font-medium">${(currentStock.lastPrice / currentStock.faceValue).toFixed(2)}x</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-600">মোট স্কোর:</span>
                    <span class="font-medium">${currentStock.totalScore}</span>
                </div>
            `;

            // Update analysis summary
            updateAnalysisSummary();
            
            // Load TradingView chart (only when needed)
            loadTradingViewChart(currentStock.ticker + ':DHAKA');
        }

        // Load TradingView widget
        function loadTradingViewChart(symbol) {
            if (tvWidget) {
                tvWidget.remove();
            }
            
            tvWidget = new TradingView.widget({
                autosize: true,
                symbol: symbol,
                interval: "D",
                timezone: "Asia/Dhaka",
                theme: "light",
                style: "1",
                locale: "en",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                allow_symbol_change: true,
                container_id: "tradingview-chart"
            });
        }

        // Update analysis summary in Bangla
        function updateAnalysisSummary() {
            let summary = '';
            
            // Revenue growth analysis
            if (currentStock.revenueCAGR5Y > 15) {
                summary += `<p class="mb-2">এই কোম্পানির আয় ৫ বছরে গড়ে ${currentStock.revenueCAGR5Y}% হারে বৃদ্ধি পেয়েছে, যা অত্যন্ত শক্তিশালী গ্রোথ নির্দেশ করে।</p>`;
            } else if (currentStock.revenueCAGR5Y > 5) {
                summary += `<p class="mb-2">আয়ের গ্রোথ মাঝারি পর্যায়ের (৫ বছরে গড়ে ${currentStock.revenueCAGR5Y}%), যা স্থিতিশীল ব্যবসা নির্দেশ করে।</p>`;
            } else {
                summary += `<p class="mb-2">আয়ের গ্রোথ দুর্বল (৫ বছরে গড়ে ${currentStock.revenueCAGR5Y}%), যা চিন্তার কারণ হতে পারে।</p>`;
            }
            
            // Profit growth analysis
            if (currentStock.netProfitCAGR5Y > 20) {
                summary += `<p class="mb-2">নিট লাভের গ্রোথ অসাধারণ (৫ বছরে গড়ে ${currentStock.netProfitCAGR5Y}%), যা কোম্পানির লাভজনকতা দেখায়।</p>`;
            } else if (currentStock.netProfitCAGR5Y > currentStock.revenueCAGR5Y) {
                summary += `<p class="mb-2">নিট লাভের গ্রোথ (${currentStock.netProfitCAGR5Y}%) আয়ের গ্রোথকে ছাড়িয়ে গেছে, যা অপারেশনাল দক্ষতা নির্দেশ করে।</p>`;
            } else {
                summary += `<p class="mb-2">নিট লাভের গ্রোথ (${currentStock.netProfitCAGR5Y}%) উন্নতির সুযোগ রাখে।</p>`;
            }
            
            // Face value analysis
            const priceToFaceValue = (currentStock.lastPrice / currentStock.faceValue).toFixed(2);
            if (priceToFaceValue > 10) {
                summary += `<p class="mb-2">স্টকটি ফেস ভ্যালুর ${priceToFaceValue}x মূল্যে লেনদেন হচ্ছে, যা উচ্চ মূল্যায়ন নির্দেশ করতে পারে।</p>`;
            } else if (priceToFaceValue > 3) {
                summary += `<p class="mb-2">ফেস ভ্যালুর ${priceToFaceValue}x মূল্যে লেনদেন হচ্ছে, যা যুক্তিসঙ্গত পর্যায়ে আছে।</p>`;
            } else {
                summary += `<p class="mb-2">ফেস ভ্যালুর ${priceToFaceValue}x মূল্যে লেনদেন হচ্ছে, যা আকর্ষণীয় মূল্যায়ন নির্দেশ করে।</p>`;
            }
            
            // Final recommendation
            if (currentStock.totalScore > 120) {
                summary += `<p class="mt-4 font-medium text-green-600">সুপারিশ: এই স্টকটি আমাদের স্ক্রিনারে উচ্চ স্কোর (${currentStock.totalScore}) পেয়েছে এবং দীর্ঘমেয়াদী বিনিয়োগের জন্য উপযুক্ত বলে বিবেচিত হয়েছে।</p>`;
            } else if (currentStock.totalScore > 80) {
                summary += `<p class="mt-4 font-medium text-yellow-600">সুপারিশ: এই স্টকটি মাঝারি স্কোর (${currentStock.totalScore}) পেয়েছে। বিনিয়োগের পূর্বে আরও বিশ্লেষণ প্রয়োজন।</p>`;
            } else {
                summary += `<p class="mt-4 font-medium text-red-600">সতর্কতা: এই স্টকটি নিম্ন স্কোর (${currentStock.totalScore}) পেয়েছে। বিনিয়োগে সতর্কতা অবলম্বন করুন।</p>`;
            }
            
            document.getElementById('analysisSummary').innerHTML = summary;
        }

        // Show the table view
        function showTableView() {
            if (tvWidget) {
                tvWidget.remove();
                tvWidget = null;
            }
            document.getElementById('tableView').classList.remove('hidden');
            document.getElementById('detailView').classList.add('hidden');
        }

        // Update the last updated time
        function updateLastUpdatedTime() {
            const now = new Date();
            document.getElementById('updateTime').textContent = now.toLocaleTimeString();
        }
    </script>
</body>
</html>
